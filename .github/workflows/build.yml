name: Build Prism Editor

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      packages: write

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['20']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # FIX 1: Force Python 3.11 on all OSs (fixes macOS 'distutils' error)
    - name: Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' 

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    # FIX 2: Install correct Linux libraries for Ubuntu 24.04
    - name: Install Linux Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libx11-dev libxkbfile-dev libsecret-1-dev libkrb5-dev libgtk-3-dev libxss-dev libasound2-dev

    - name: Clean npm cache
      shell: bash
      run: npm cache clean --force

    - name: Configure and Install Dependencies
      shell: bash
      env:
        # FIX 3: Pass Token to allow ripgrep download on macOS (Fixes 403 Forbidden)
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PYTHON: python
      run: |
        echo "üîß Applying version overrides..."
        
        # FIX 4: THE CRITICAL FIX FOR WINDOWS AND LINUX
        # Force node-addon-api to v7.1.0. 
        # v8.0.0+ crashes Electron 27 builds with 'node_api_nogc_env' errors.
        npm pkg set overrides.node-addon-api="7.1.0"
        
        echo "üì¶ Installing dependencies..."
        # We run install AFTER setting the override so it downloads the working version
        npm install --no-fund --no-audit

    - name: Ensure Electron Builder Config
      shell: bash
      run: |
        # Only create if completely missing
        if [ ! -f "electron-builder.config.js" ] && [ ! -f "electron-builder.config.cjs" ] && [ ! -f ".electron-builder.config.js" ] && [ ! -f ".electron-builder.config.cjs" ]; then
          echo "No config found. Creating default electron-builder.config.cjs..."
          # FIX 5: Added 'identity: null' for macOS to prevent code signing errors
          echo 'module.exports = {
            productName: "Prism Editor",
            appId: "com.prism-editor.app",
            directories: { output: "release" },
            files: ["out/**/*", "dist/**/*", "package.json"],
            win: { target: "nsis" },
            mac: { target: "dmg", identity: null }, 
            linux: { target: "AppImage" }
          };' > electron-builder.config.cjs
        fi

    - name: Compile Project
      shell: bash
      env:
        NODE_OPTIONS: --max-old-space-size=8192
      run: |
        if npm run compile --if-present; then
          echo "‚úÖ Compile successful"
        elif npm run build --if-present; then
          echo "‚úÖ Build successful"
        else
          echo "‚ö†Ô∏è No compile/build script found, proceeding..."
        fi

    - name: Package Application
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        USE_HARD_LINKS: false
      run: |
        # Select Flag based on OS
        if [ "$RUNNER_OS" = "Windows" ]; then FLAGS="--win"; fi
        if [ "$RUNNER_OS" = "macOS" ]; then FLAGS="--mac"; fi
        if [ "$RUNNER_OS" = "Linux" ]; then FLAGS="--linux"; fi

        echo "üöÄ Packaging for $RUNNER_OS..."

        # Use explicit config if we created one to avoid confusion
        if [ -f "electron-builder.config.cjs" ]; then
           npx electron-builder build $FLAGS --config electron-builder.config.cjs
        else
           npx electron-builder build $FLAGS
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os }}-build
        path: |
          release/*.exe
          release/*.dmg
          release/*.AppImage
          release/*.snap
          release/*.zip
          dist/*.exe
          dist/*.dmg
          dist/*.AppImage
        if-no-files-found: warn
