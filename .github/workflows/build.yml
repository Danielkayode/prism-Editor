name: Build Prism Editor

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  pull_request:
    branches: [main, master]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - debug

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.18.0'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      actions: write
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos

    steps:
    # ========================================
    # Setup Environment
    # ========================================
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # ========================================
    # Install Node.js (Cross-platform)
    # ========================================
    - name: Install Node.js
      shell: bash
      run: |
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          # Windows - Use PowerShell within bash
          pwsh -Command "
            \$$nodeUrl = 'https://nodejs.org/dist/v${{ env.NODE_VERSION }}/node-v${{ env.NODE_VERSION }}-win-x64.zip';
            Write-Host \"Downloading \$$nodeUrl\";
            if (Test-Path 'node.zip') { Remove-Item node.zip };
            Invoke-WebRequest -Uri \$$nodeUrl -OutFile node.zip;
            if (Test-Path 'C:\\node') { Remove-Item -Recurse -Force C:\\node };
            Expand-Archive node.zip -DestinationPath C:\\node;
            Add-Content -Path \$$env:GITHUB_PATH -Value 'C:\\node\\node-v${{ env.NODE_VERSION }}-win-x64';
            Add-Content -Path \$$env:GITHUB_PATH -Value 'C:\\node\\node-v${{ env.NODE_VERSION }}-win-x64\\node_modules\\npm\\bin';
          "
        elif [[ "${{ matrix.platform }}" == "macos" ]]; then
          # macOS
          if [ -d "$GITHUB_WORKSPACE/node-v${{ env.NODE_VERSION }}-darwin-arm64" ]; then
            rm -rf "$GITHUB_WORKSPACE/node-v${{ env.NODE_VERSION }}-darwin-arm64"
          fi
          curl -fsSL "https://nodejs.org/dist/v${{ env.NODE_VERSION }}/node-v${{ env.NODE_VERSION }}-darwin-arm64.tar.gz" | tar -xz
          echo "$GITHUB_WORKSPACE/node-v${{ env.NODE_VERSION }}-darwin-arm64/bin" >> $GITHUB_PATH
        else
          # Linux - Use official setup
          if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
        fi

    - name: Verify Node.js Installation
      shell: bash
      run: |
        node --version
        npm --version
        which node
        which npm

    # ========================================
    # Install System Dependencies
    # ========================================
    - name: Install Linux Dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          python3 \
          python3-pip \
          libx11-dev \
          libxkbfile-dev \
          libsecret-1-dev \
          libkrb5-dev \
          libnotify-dev \
          libgtk-3-dev \
          libgbm-dev \
          libxtst-dev \
          libnss3 \
          libasound2t64 \
          libatk-bridge2.0-0 \
          libdrm2 \
          libxcomposite1 \
          libxdamage1 \
          libxrandr2 \
          libpango-1.0-0 \
          libcairo2 \
          libcups2 \
          libxss1 \
          libxcursor1 \
          fakeroot \
          rpm \
          dpkg

    - name: Install Windows Dependencies
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        choco install python311 -y --no-progress
        echo "C:\Python311" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    # ========================================
    # Configure Python for node-gyp
    # ========================================
    - name: Get Python Path
      id: python
      shell: bash
      run: |
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          echo "path=C:\Python311\python.exe" >> $GITHUB_OUTPUT
        else
          PYTHON_PATH=$(which python3)
          echo "path=$PYTHON_PATH" >> $GITHUB_OUTPUT
          echo "Python found at: $PYTHON_PATH"
        fi

    - name: Configure node-gyp
      shell: bash
      run: |
        npm config set python "${{ steps.python.outputs.path }}"
        if [[ "${{ matrix.platform }}" == "windows" ]]; then
          npm config set msvs_version 2022
        fi
        npm config list

    - name: Install Node Dependencies
      env:
        NODE_OPTIONS: --max-old-space-size=8192
      run: |
        npm install --no-audit --no-fund --no-package-lock

    # ========================================
    # Build Application
    # ========================================
    - name: Compile TypeScript
      env:
        NODE_OPTIONS: --max-old-space-size=8192
      run: npm run compile

    - name: Verify Build Output
      shell: bash
      run: |
        if [ ! -d "out" ]; then
          echo "Build failed: out directory not found"
          exit 1
        fi
        echo "Build successful: $(find out -type f | wc -l) files generated"

    - name: Rebuild Native Modules
      run: |
        if npm run | grep -q rebuild; then
          npm run rebuild
        fi

    # ========================================
    # Package Application
    # ========================================
    - name: Package Electron Application
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NODE_OPTIONS: --max-old-space-size=8192
      run: |
        mkdir -p dist
        
        case "${{ matrix.platform }}" in
          linux)
            npx electron-builder --linux --x64 --publish never
            ;;
          windows)
            npx electron-builder --windows --x64 --publish never
            ;;
          macos)
            npx electron-builder --mac --x64 --arm64 --publish never
            ;;
        esac

    # ========================================
    # Upload Results
    # ========================================
    - name: Upload Build Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: prism-editor-${{ matrix.platform }}-${{ github.sha }}
        path: |
          dist/
          !dist/**/*.pdb
          !dist/**/*.dbg
          !dist/**/*.dSYM
        compression-level: 6
        retention-days: 7

    - name: Upload Logs on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.platform }}-${{ github.sha }}
        path: |
          npm-debug.log*
          *.log
          out/*.log
        retention-days: 14
