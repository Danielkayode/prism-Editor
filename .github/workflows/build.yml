name: Build Prism Editor

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      packages: write

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['20']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11' 

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'yarn' 
        # Changed to 'yarn' because VS Code forks require yarn.lock

    - name: Install Linux Dependencies
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libx11-dev libxkbfile-dev libsecret-1-dev libkrb5-dev libgtk-3-dev libxss-dev libasound2-dev

    - name: Setup Yarn and Fix Dependencies
      shell: bash
      run: |
        echo "üîß Installing Yarn..."
        npm install -g yarn

        echo "üîß Injecting 'resolutions' to force node-addon-api v7.1.0..."
        # We use a Node script to edit package.json because it works on Windows too.
        # This fixes the C++ 'node_api_nogc_env' crash by forcing the older API version.
        node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.resolutions = { ...pkg.resolutions, 'node-addon-api': '7.1.0' };
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
        "

    - name: Install Dependencies
      shell: bash
      env:
        # Token needed for @vscode/ripgrep download on macOS
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PYTHON: python
        # Prevent node-gyp concurrency issues on Windows
        CHILD_CONCURRENCY: 1
      run: |
        echo "üì¶ Installing with Yarn..."
        # --frozen-lockfile=false allows Yarn to update the lockfile with our new resolution
        yarn install --frozen-lockfile=false --network-timeout 100000

    - name: Compile Project
      shell: bash
      env:
        NODE_OPTIONS: --max-old-space-size=8192
      run: |
        echo "üî® Compiling..."
        # Using yarn run compile ensures we use the environment set up by yarn
        yarn run compile

    - name: Verify Build
      shell: bash
      run: |
        # Fail early if main.js wasn't created
        if [ ! -f "out/main.js" ] && [ ! -d "out" ]; then
          echo "‚ùå Error: Build failed to generate 'out/main.js'. Packaging will fail."
          exit 1
        fi
        echo "‚úÖ Build verified, proceeding to package."

    - name: Package Application
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        USE_HARD_LINKS: false
      run: |
        # Select Flag based on OS
        if [ "$RUNNER_OS" = "Windows" ]; then FLAGS="--win"; fi
        if [ "$RUNNER_OS" = "macOS" ]; then FLAGS="--mac"; fi
        if [ "$RUNNER_OS" = "Linux" ]; then FLAGS="--linux"; fi

        echo "üöÄ Packaging for $RUNNER_OS..."
        
        # Check if we need to point to a specific config file
        if [ -f "electron-builder.config.cjs" ]; then
           npx electron-builder build $FLAGS --config electron-builder.config.cjs
        else
           # This uses your existing electron-builder.yml
           npx electron-builder build $FLAGS
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.os }}-build
        path: |
          release/*.exe
          release/*.dmg
          release/*.AppImage
          release/*.snap
          release/*.zip
          dist/*.exe
          dist/*.dmg
          dist/*.AppImage
        if-no-files-found: warn
