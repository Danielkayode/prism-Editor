name: Build Prism Editor

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: {}

env:
  NODE_VERSION: '20'
  ELECTRON_CACHE: ${{ github.workspace }}/.cache/electron
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
      packages: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    # ----------------------------------------
    # Platform-Specific Dependencies
    # ----------------------------------------

    - name: Install Linux Dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          python3 \
          python3-pip \
          libx11-dev \
          libxkbfile-dev \
          libsecret-1-dev \
          libkrb5-dev \
          libnotify-dev \
          libgtk-3-dev \
          libxtst-dev \
          libnss3 \
          libasound2 \
          libatk-bridge2.0-0 \
          libdrm2 \
          libxrandr2 \
          libgbm-dev \
          fakeroot \
          rpm \
          dpkg

    - name: Configure Windows Environment
      if: matrix.platform == 'windows'
      shell: powershell
      run: |
        choco install python311 -y --no-progress --force
        refreshenv

        echo "npm_config_msvs_version=2022" >> $env:GITHUB_ENV
        echo "npm_config_python=C:\\Python311\\python.exe" >> $env:GITHUB_ENV

    - name: Install macOS Dependencies
      if: matrix.platform == 'macos'
      run: |
        xcode-select --install || true

    # ----------------------------------------
    # Cache Setup
    # ----------------------------------------

    - name: Cache Electron
      uses: actions/cache@v4
      with:
        path: ${{ env.ELECTRON_CACHE }}
        key: ${{ runner.os }}-electron-cache-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-electron-cache-

    - name: Cache Electron Builder
      uses: actions/cache@v4
      with:
        path: ${{ env.ELECTRON_BUILDER_CACHE }}
        key: ${{ runner.os }}-electron-builder-cache-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-electron-builder-cache-

    # ----------------------------------------
    # Install Dependencies
    # ----------------------------------------

    - name: Clean npm cache
      run: npm cache clean --force

    - name: Install Dependencies
      run: |
        npm ci --no-audit --no-fund

    # ----------------------------------------
    # Patch (if needed)
    # ----------------------------------------

    - name: Apply TypeScript Patches
      shell: bash
      run: |
        if [ -f "extensions/tunnel-forwarding/src/split.ts" ]; then
          if sed --version 2>&1 | grep -q GNU; then
            sed -i '1s;^;// @ts-nocheck\n;' extensions/tunnel-forwarding/src/split.ts
          else
            sed -i '' '1s;^;// @ts-nocheck\n;' extensions/tunnel-forwarding/src/split.ts
          fi
        fi

    # ----------------------------------------
    # Build
    # ----------------------------------------

    - name: Compile Project
      run: |
        npm run compile

    - name: Rebuild Native Modules
      run: |
        if npm run rebuild --if-present; then
          echo "Native modules rebuilt"
        else
          echo "No rebuild script or rebuild skipped"
        fi

    # ----------------------------------------
    # Package
    # ----------------------------------------

    - name: Package Application
      run: |
        echo "Packaging for ${{ matrix.platform }}"

        case "${{ matrix.platform }}" in
          linux)
            npx electron-builder --linux --x64 --publish never
            ;;
          windows)
            npx electron-builder --win --x64 --publish never
            ;;
          macos)
            npx electron-builder --mac --x64 --arm64 --publish never
            ;;
        esac

    - name: List Build Artifacts
      run: |
        echo "Artifacts in dist/"
        find dist -type f -print || ls -la dist/

    # ----------------------------------------
    # Upload Artifacts
    # ----------------------------------------

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: prism-editor-${{ matrix.platform }}-${{ github.run_number }}
        path: |
          dist/*.exe
          dist/*.dmg
          dist/*.AppImage
          dist/*.deb
          dist/*.rpm
          dist/**/*.exe
          dist/**/*.dmg
          dist/**/*.AppImage
          dist/**/*.deb
          dist/**/*.rpm
        if-no-files-found: warn
        retention-days: 7

    - name: Upload Build Logs on Failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: build-logs-${{ matrix.platform }}-${{ github.run_number }}
        path: |
          npm-debug.log*
          *.log
        if-no-files-found: ignore
        retention-days: 90
