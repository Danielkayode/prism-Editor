name: Build Prism Editor

on:
  push:
    branches: [main, master]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  pull_request:
    branches: [main, master]
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - debug

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      actions: write
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            image: node:20-bullseye
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos

    steps:
    # ========================================
    # Setup Environment
    # ========================================
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # Container setup for Linux (includes Node.js + Python)
    - name: Setup Linux Environment
      if: matrix.platform == 'linux'
      run: |
        echo "NODE_BIN=/usr/local/bin" >> $GITHUB_ENV
        
    - name: Setup Node.js (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        # Install Node.js 20 using direct download
        $nodeUrl = "https://nodejs.org/dist/v${env:NODE_VERSION}/node-v${env:NODE_VERSION}-win-x64.zip"
        Invoke-WebRequest -Uri $nodeUrl -OutFile node.zip
        Expand-Archive node.zip -DestinationPath C:\node
        echo "C:\node\node-v${env:NODE_VERSION}-win-x64" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        
    - name: Setup Node.js (macOS)
      if: matrix.platform == 'macos'
      run: |
        # Install Node.js 20 using direct download
        curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-darwin-arm64.tar.gz" | tar -xz
        echo "$GITHUB_WORKSPACE/node-v${NODE_VERSION}-darwin-arm64/bin" >> $GITHUB_PATH

    - name: Verify Node.js Installation
      run: |
        node --version
        npm --version

    # ========================================
    # Install Dependencies
    # ========================================
    - name: Install Dependencies (Linux)
      if: matrix.platform == 'linux'
      run: |
        apt-get update && apt-get install -y \
          build-essential python3 libx11-dev libxkbfile-dev libsecret-1-dev \
          libkrb5-dev libnotify-dev libgtk-3-dev libgbm-dev libxtst-dev \
          libnss3 libasound2 libatk-bridge2.0-0 libdrm2 libxcomposite1 \
          libxdamage1 libxrandr2 libpango-1.0-0 libcairo2 libcups2 \
          libxss1 libxcursor1 fakeroot rpm dpkg

    - name: Install Dependencies (Windows)
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        choco install python311 -y --no-progress
        echo "C:\Python311" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    # ========================================
    # Configure Build
    # ========================================
    - name: Configure node-gyp
      shell: bash
      run: |
        npm config set python python3 --global
        npm config set msvs_version 2022 --global
        
    - name: Install Node Dependencies
      env:
        NODE_OPTIONS: --max-old-space-size=8192
      run: |
        # Use npm install since no lock file exists
        npm install --no-audit --no-fund --no-package-lock
        
    # ========================================
    # Build Application
    # ========================================
    - name: Compile TypeScript
      env:
        NODE_OPTIONS: --max-old-space-size=8192
      run: npm run compile
        
    - name: Verify Build Output
      run: |
        if [ ! -d "out" ]; then
          echo "Build failed: out directory not found"
          exit 1
        fi
        echo "Build successful: $(ls -la out/ | wc -l) files generated"
        
    - name: Rebuild Native Modules
      run: |
        if npm run | grep -q rebuild; then
          npm run rebuild
        fi
        
    # ========================================
    # Package Application
    # ========================================
    - name: Package Electron Application
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NODE_OPTIONS: --max-old-space-size=8192
      run: |
        mkdir -p dist
        
        case "${{ matrix.platform }}" in
          linux)
            npx electron-builder --linux --x64 --publish never
            ;;
          windows)
            npx electron-builder --windows --x64 --publish never
            ;;
          macos)
            npx electron-builder --mac --x64 --arm64 --publish never
            ;;
        esac
        
    # ========================================
    # Upload Results
    # ========================================
    - name: Upload Build Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: prism-editor-${{ matrix.platform }}-${{ github.sha }}
        path: |
          dist/
          !dist/**/*.pdb
          !dist/**/*.dbg
        compression-level: 6
        retention-days: 7
        
    - name: Upload Logs on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.platform }}-${{ github.sha }}
        path: |
          npm-debug.log*
          *.log
          out/*.log
        retention-days: 14
