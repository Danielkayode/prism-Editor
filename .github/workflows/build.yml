name: Build Prism Editor

on:
  push:
    branches: [main, master]
    paths-ignore: ['**/*.md', 'docs/**']
  pull_request:
    branches: [main, master]
    paths-ignore: ['**/*.md', 'docs/**']
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'production'
        type: choice
        options: [production, debug]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      actions: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # ========================================
    # Setup Node.js (Before any npm commands)
    # ========================================
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    # ========================================
    # Configure Build Tools (BEFORE npm install)
    # ========================================
    - name: Configure Windows Build Tools
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        echo "npm_config_msvs_version=2022" >> $env:GITHUB_ENV
        echo "npm_config_python=C:\\Python311\\python.exe" >> $env:GITHUB_ENV

    - name: Configure Python Path (Unix)
      if: matrix.platform != 'windows'
      shell: bash
      run: |
        PYTHON_PATH=$(which python3 || which python || echo "/usr/bin/python3")
        echo "Python found at: $PYTHON_PATH"
        npm config set python "$PYTHON_PATH"
        python3 --version

    # ========================================
    # Install Platform Dependencies
    # ========================================
    - name: Install Linux Dependencies
      if: matrix.platform == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential python3 python3-pip \
          libx11-dev libxkbfile-dev libsecret-1-dev \
          libkrb5-dev libnotify-dev libgtk-3-dev \
          libgbm-dev libxtst-dev libnss3 \
          libasound2t64 \
          libatk-bridge2.0-0 libdrm2 \
          libxcomposite1 libxdamage1 libxrandr2 \
          libpango-1.0-0 libcairo2 libcups2 \
          libxss1 libxcursor1 \
          fakeroot rpm dpkg

    - name: Install macOS Dependencies
      if: matrix.platform == 'macos'
      run: |
        xcode-select --install 2>/dev/null || true
        brew install pkg-config

    - name: Install Windows Build Tools
      if: matrix.platform == 'windows'
      shell: pwsh
      run: |
        choco install python311 -y --no-progress
        echo "C:\Python311" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

    # ========================================
    # Install Node Dependencies
    # ========================================
    - name: Install Dependencies
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NODE_OPTIONS: --max-old-space-size=8192
      run: |
        npm ci --no-fund --no-audit

    # ========================================
    # Build Application
    # ========================================
    - name: Compile TypeScript
      env:
        NODE_OPTIONS: --max-old-space-size=8192
      run: npm run compile

    - name: Verify Build Output
      shell: bash
      run: |
        if [ ! -d "out" ]; then
          echo "❌ Build failed: out directory not found"
          exit 1
        fi
        echo "✅ Build successful: $(find out -type f -name "*.js" | wc -l) files generated"

    # ========================================
    # Package Application
    # ========================================
    - name: Package Application
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Ensure config exists
        if [ ! -f "electron-builder.config.js" ] && [ ! -f ".electron-builder.config.js" ] && [ ! -f "electron-builder.config.cjs" ]; then
          echo 'module.exports = { productName: "Prism Editor", appId: "com.prism-editor.app", directories: { output: "release" }, files: ["out/**/*", "resources/**/*", "package.json"] };' > electron-builder.config.js
        fi
        
        # Package with platform detection
        case "${{ runner.os }}" in
          Windows) PLATFORM_FLAG="--win" ;;
          macOS)   PLATFORM_FLAG="--mac" ;;
          Linux)   PLATFORM_FLAG="--linux" ;;
        esac
        
        npx electron-builder $PLATFORM_FLAG --publish never

    # ========================================
    # Upload Artifacts
    # ========================================
    - name: Prepare Artifacts
      shell: bash
      run: |
        # Create dist directory if not exists
        mkdir -p dist
        
        # Find and copy artifacts
        find release dist out -type f \( -name "*.AppImage" -o -name "*.dmg" -o -name "*.exe" -o -name "*.zip" -o -name "*.tar.gz" \) -exec cp {} dist/ \; 2>/dev/null || true
        
        echo "Artifacts found:"
        ls -la dist/ || echo "No artifacts found"

    - name: Upload Build Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: prism-editor-${{ runner.os }}-${{ github.sha }}
        path: dist/
        compression-level: 6
        retention-days: 7
